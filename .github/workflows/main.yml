name: RDP via Tailscale

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  secure-rdp:
    # This must run on a Windows runner
    runs-on: windows-latest
    # Optional: set a timeout to prevent runners from running indefinitely
    timeout-minutes: 3600

    steps:
      - name: Install Tailscale
        # You may need to use a specific URL based on the latest version
        shell: powershell
        run: |
          $installerPath = "C:\temp\tailscale-setup.msi"
          # Download the latest stable Tailscale MSI installer
          Invoke-WebRequest -Uri pkgs.tailscale.com -OutFile $installerPath
          msiexec /i $installerPath /qn /norestart | Write-Host
          # Start the Tailscale service
          Start-Service -Name Tailscale
      
      - name: Establish Tailscale Connection
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci-rdp
          # Optional: Use ephemeral nodes that clean up automatically
          ephemeral: true

      - name: Configure Windows RDP & Firewall
        shell: powershell
        run: |
          # Enable RDP on the system
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          # Allow RDP traffic through the Windows Firewall for the Tailscale IP range (100.64.0.0/10)
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=100.64.0.0/10
          # Restart the Remote Desktop Service to apply changes
          Restart-Service -Name TermService -Force
      
      - name: Create RDP User with Fixed Password
        shell: powershell
        env:
          RDP_USER_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          # Note: The password will be masked in GitHub logs if added as a secret
          $securePass = ConvertTo-SecureString $env:RDP_USER_PASSWORD -AsPlainText -Force
          # Create a new local user and add them to the "Remote Desktop Users" group
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          # Get the Tailscale IP and store it as a workflow environment variable
          $tsIP = (tailscale ip -4)
          Add-Content -Path $env:GITHUB_ENV -Value "TAILSCALE_IP=$tsIP"

      - name: Print Connection Details
        run: |
          echo "RDP into the runner using IP: ${{ env.TAILSCALE_IP }}"
          echo "Username: RDPUser"
          echo "Password: The secret RDP_PASSWORD you configured"
          echo "This workflow will run for 60 minutes or until manually canceled."
          # Keep the workflow alive so you can connect
          Start-Sleep -Seconds 3600 # Sleeps for an hour
          
